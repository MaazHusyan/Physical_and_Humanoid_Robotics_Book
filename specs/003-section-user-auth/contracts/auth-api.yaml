openapi: 3.1.0
info:
  title: User Authentication & Authorization API
  description: |
    API endpoints for user registration, authentication, profile management, and admin operations.
    Integrates with existing RAG chat system to provide user-specific conversation history.
  version: 1.0.0
  contact:
    name: Physical and Humanoid Robotics Book
    url: https://github.com/MaazHusyan/Physical_and_Humanoid_Robotics_Book

servers:
  - url: http://localhost:8000/api/v1
    description: Development server
  - url: https://api.roboticsbook.example.com/api/v1
    description: Production server

tags:
  - name: Authentication
    description: User registration, login, logout, and token management
  - name: Profile
    description: User profile viewing and updating
  - name: Chat History
    description: User-specific conversation history retrieval
  - name: Admin
    description: Administrative operations (admin role required)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token for authenticated requests

  schemas:
    # Request/Response Models
    UserRegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address (login credential)
          example: student@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: Password (min 8 chars, 1 uppercase, 1 number)
          example: SecurePass123
        full_name:
          type: string
          maxLength: 255
          description: User's display name (optional)
          example: John Doe
        institution:
          type: string
          maxLength: 255
          description: Educational institution (optional)
          example: MIT

    UserLoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: Email address (OAuth2 standard uses 'username' field)
          example: student@example.com
        password:
          type: string
          format: password
          example: SecurePass123

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: Short-lived JWT access token (15-30 min)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          description: Long-lived refresh token (7 days, httpOnly cookie)
          example: 3f2504e0-4f89-11d3-9a0c-0305e82c3301
        token_type:
          type: string
          enum: [bearer]
          example: bearer
        expires_in:
          type: integer
          description: Access token lifetime in seconds
          example: 1800

    TokenRefreshRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
          description: Valid refresh token from login
          example: 3f2504e0-4f89-11d3-9a0c-0305e82c3301

    UserResponse:
      type: object
      properties:
        id:
          type: integer
          example: 1
        email:
          type: string
          format: email
          example: student@example.com
        full_name:
          type: string
          nullable: true
          example: John Doe
        institution:
          type: string
          nullable: true
          example: MIT
        role:
          type: string
          enum: [student, admin]
          example: student
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2026-01-02T10:30:00Z"
        last_login_at:
          type: string
          format: date-time
          nullable: true
          example: "2026-01-02T12:45:00Z"

    UserUpdateRequest:
      type: object
      properties:
        full_name:
          type: string
          maxLength: 255
          example: Jane Smith
        institution:
          type: string
          maxLength: 255
          example: Stanford University

    PasswordChangeRequest:
      type: object
      required:
        - current_password
        - new_password
      properties:
        current_password:
          type: string
          format: password
          example: OldPassword123
        new_password:
          type: string
          format: password
          minLength: 8
          example: NewSecurePass456

    ChatSessionResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        user_id:
          type: integer
          nullable: true
          example: 1
        title:
          type: string
          nullable: true
          example: "Discussion on forward kinematics"
        created_at:
          type: string
          format: date-time
          example: "2026-01-02T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-01-02T10:15:00Z"
        message_count:
          type: integer
          description: Number of messages in session
          example: 6

    ChatMessageResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        session_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        role:
          type: string
          enum: [user, assistant]
          example: user
        content:
          type: string
          example: "What is forward kinematics?"
        created_at:
          type: string
          format: date-time
          example: "2026-01-02T10:00:00Z"
        model_used:
          type: string
          nullable: true
          example: "groq/llama-3.3-70b"
        sources:
          type: array
          items:
            type: string
          nullable: true
          example: ["/docs/kinematics#forward"]

    AdminUserListResponse:
      type: object
      properties:
        total:
          type: integer
          example: 150
        page:
          type: integer
          example: 1
        page_size:
          type: integer
          example: 20
        users:
          type: array
          items:
            $ref: '#/components/schemas/UserResponse'

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
          example: "Invalid credentials"

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user account
      description: |
        Create a new user account with email and password.
        Validates email format and password strength.
        Default role is 'student'.
      operationId: register_user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid input (email format, password strength, duplicate email)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                duplicate_email:
                  value:
                    detail: "Email already registered"
                weak_password:
                  value:
                    detail: "Password must contain at least one uppercase letter and one number"

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: |
        Authenticate user with email and password.
        Returns access token (JWT) and refresh token.
        Rate limited: 5 attempts per 15 minutes per IP.
      operationId: login_user
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/UserLoginRequest'
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              description: Refresh token stored in httpOnly cookie
              schema:
                type: string
                example: refresh_token=abc123; HttpOnly; Secure; SameSite=Lax; Max-Age=604800
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Incorrect email or password"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Too many login attempts. Try again in 15 minutes."

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: |
        Invalidate current refresh token.
        Client should discard access token.
      operationId: logout_user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out successfully"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: |
        Generate new access token using refresh token.
        Implements token rotation (old refresh token invalidated).
      operationId: refresh_token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TokenRefreshRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me:
    get:
      tags:
        - Profile
      summary: Get current user profile
      description: Retrieve authenticated user's profile information
      operationId: get_current_user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - Profile
      summary: Update current user profile
      description: Update user's full name and institution
      operationId: update_current_user
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/password:
    post:
      tags:
        - Profile
      summary: Change user password
      description: |
        Change password with current password verification.
        Rate limited: 3 attempts per hour per user.
      operationId: change_password
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordChangeRequest'
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Password updated successfully"
        '400':
          description: Invalid current password or weak new password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /chat/history:
    get:
      tags:
        - Chat History
      summary: Get user's chat sessions
      description: |
        Retrieve list of chat sessions for authenticated user.
        Sorted by most recent first.
        Supports pagination.
      operationId: get_chat_history
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Number of sessions per page
      responses:
        '200':
          description: Chat history retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    example: 15
                  page:
                    type: integer
                    example: 1
                  page_size:
                    type: integer
                    example: 20
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChatSessionResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /chat/sessions/{session_id}/messages:
    get:
      tags:
        - Chat History
      summary: Get messages in a session
      description: |
        Retrieve all messages for a specific chat session.
        Only accessible if session belongs to authenticated user.
      operationId: get_session_messages
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chat session UUID
      responses:
        '200':
          description: Messages retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    $ref: '#/components/schemas/ChatSessionResponse'
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChatMessageResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Session does not belong to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/users:
    get:
      tags:
        - Admin
      summary: List all users (admin only)
      description: |
        Retrieve paginated list of all users.
        Requires admin role.
      operationId: list_users_admin
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Users list retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUserListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Insufficient permissions (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/users/{user_id}:
    get:
      tags:
        - Admin
      summary: Get user by ID (admin only)
      description: Retrieve specific user details including activity
      operationId: get_user_admin
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: User retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Not authenticated
        '403':
          description: Insufficient permissions
        '404':
          description: User not found

    patch:
      tags:
        - Admin
      summary: Update user (admin only)
      description: |
        Admin can update any user's profile and status.
        Cannot disable own admin account.
      operationId: update_user_admin
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                is_active:
                  type: boolean
                  example: false
                role:
                  type: string
                  enum: [student, admin]
                  example: admin
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid operation (e.g., self-disable)
        '401':
          description: Not authenticated
        '403':
          description: Insufficient permissions
        '404':
          description: User not found

  /admin/stats:
    get:
      tags:
        - Admin
      summary: Get platform statistics (admin only)
      description: |
        Retrieve platform-wide statistics:
        - Total users
        - Active sessions
        - Usage metrics
      operationId: get_admin_stats
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Statistics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_users:
                    type: integer
                    example: 150
                  active_users_today:
                    type: integer
                    example: 45
                  total_chat_sessions:
                    type: integer
                    example: 892
                  total_messages:
                    type: integer
                    example: 5340
        '401':
          description: Not authenticated
        '403':
          description: Insufficient permissions

security:
  - BearerAuth: []
